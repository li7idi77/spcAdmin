<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.easycompany.mapper.InstructorMapper">
	<!-- 유저 -->
	<select id="getBoardList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT BOARD_IDX,
	    CASE BOARD_TYPE
	 		WHEN 05 THEN '강사공지'
	 		WHEN 06 THEN '강사자료실'
		 END AS BOARD_TYPE,
	    TITLE, LINK_URL, FILE_ID, VIEW_CNT, CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19) ) AS REG_DT, REG_ID, REG_NM,
	    (SELECT COUNT(*) FROM edu_file WHERE FILE_KEY = BOARD_IDX AND FILE_GUBUN = 'board') AS FIEL_CNT, CONTENTS
	      FROM edu_board
	     WHERE USE_YN = 'Y'
	     <if test="searchCondition !=null and searchCondition == 'ALL'">
	      	AND (TITLE LIKE CONCAT('%', #{searchKeyword}, '%') OR REG_ID LIKE CONCAT('%', #{searchKeyword}, '%') OR CONTENTS LIKE CONCAT('%', #{searchKeyword}, '%'))
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'TITLE'">
	      	AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'REG_NM'">
	      	AND REG_ID LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'CONTENTS'">
	      	AND CONTENTS LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchDate !=null and searchDate != 'ALL'">
	      	<![CDATA[
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) >= #{board_start_date} AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) <= #{board_end_date} 
	        ]]>
	      </if>
	      <if test="board_type !=null and board_type != ''">
	      	AND BOARD_TYPE = #{board_type}
	      </if>
	     ORDER BY BOARD_IDX DESC
	    LIMIT #{recordCountPerPage}  OFFSET  #{offset}
	</select>

	<select id="getBoardCount" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) cnt
	       FROM edu_board
	      WHERE USE_YN = 'Y'
	     <if test="searchCondition !=null and searchCondition == 'ALL'">
	      	AND (TITLE LIKE CONCAT('%', #{searchKeyword}, '%') OR REG_ID LIKE CONCAT('%', #{searchKeyword}, '%') OR CONTENTS LIKE CONCAT('%', #{searchKeyword}, '%'))
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'TITLE'">
	      	AND TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'REG_NM'">
	      	AND REG_ID LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchCondition !=null and searchCondition == 'CONTENTS'">
	      	AND CONTENTS LIKE CONCAT('%', #{searchKeyword}, '%')
	      </if>
	      <if test="searchDate !=null and searchDate != 'ALL'">
	      	<![CDATA[
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) >= #{board_start_date} AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) <= #{board_end_date} 
	        ]]>
	      </if>
	      <if test="board_type !=null and board_type != ''">
	      	AND BOARD_TYPE = #{board_type}
	      </if>
	</select>
	
	<select id="getBoardView" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT BOARD_IDX, BOARD_TYPE, TITLE, CONTENTS, LINK_URL, FILE_ID, VIEW_CNT, CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19) ) AS REG_DT, REG_NM
		       ,EDU_TYPE_01, EDU_TYPE_02, EDU_TYPE_03, EDU_TYPE_04, EDU_TYPE_05, EDU_TYPE_06, EDU_TYPE_07, EDU_TYPE_08, EDU_TYPE_09, EDU_TYPE_10, EDU_TYPE_11
	      <![CDATA[
	      ,(SELECT b.BOARD_IDX FROM EDU_BOARD b WHERE b.BOARD_TYPE = #{board_type} AND b.BOARD_IDX > #{board_idx} AND USE_YN = 'Y' ORDER BY BOARD_IDX DESC LIMIT 1) AS NEXT_IDX
	      ,(SELECT b.TITLE FROM EDU_BOARD b WHERE b.BOARD_TYPE = #{board_type} AND b.BOARD_IDX > #{board_idx} AND USE_YN = 'Y' ORDER BY BOARD_IDX DESC LIMIT 1) AS NEXT_NM
	      ,(SELECT b.BOARD_IDX FROM EDU_BOARD b WHERE b.BOARD_TYPE = #{board_type} AND b.BOARD_IDX < #{board_idx} AND USE_YN = 'Y' ORDER BY BOARD_IDX LIMIT 1) AS PREV_IDX
	      ,(SELECT b.TITLE FROM EDU_BOARD b WHERE b.BOARD_TYPE = #{board_type} AND b.BOARD_IDX < #{board_idx} AND USE_YN = 'Y' ORDER BY BOARD_IDX LIMIT 1) AS PREV_NM
	      ]]>
	     <if test="board_type !=null and board_type == '06'">
		    , NOTICE_YN
         </if>
	      FROM edu_board
	     WHERE 1=1
	    	AND BOARD_IDX = #{board_idx}
	    	AND USE_YN = 'Y'
	    	<if test="board_type !=null and board_type != ''">
	      	AND BOARD_TYPE = #{board_type}
	      </if>
	</select>
	
	<select id="getInsActList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.SCHEDULE_NO, 
			   a.EDU_NAME,
			   a.EDU_START_DATE AS EDU_DATE,
               CONCAT(SUBSTR(TIME(b.START_TIME),1,2),':',SUBSTR(TIME(b.START_TIME),4,2),'~',SUBSTR(TIME(b.END_TIME),1,2),':',SUBSTR(TIME(b.END_TIME),4,2)) AS EDU_DATETIME,
               (SELECT CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '32' AND CD = b.COPER_AREA_CD) AS AREA_NM,
               a.EDU_ORG_NAME, b.EDU_PLACE, a.EDU_NUMBER,
               a.EDU_TARGET, a.EDU_TEAC_NAME,
               CASE WHEN b.INS_TYPE = 'recruit' AND INS_STATUS IS NULL THEN '섭외중'
					WHEN b.INS_TYPE = 'recruit' AND INS_STATUS IS NOT NULL THEN '완료'
					WHEN b.INS_TYPE = 'select' AND INS_STATUS IS NULL THEN '완료'
				END
               AS INS_STATUS,
               b.SCH_STATUS,
               a.EDU_KEY,
               (SELECT 'Y' FROM EDU_SCHEDULE_APP WHERE INS_USER = #{UserAccount.user_id}) AS INS_APP_CHECK
		FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
		AND b.INS_TYPE = 'recruit'
        AND b.INS_STATUS IS NULL
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.EDU_START_DATE >= #{start_date} AND a.EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name !=null and edu_name != ''">
	      	AND a.EDU_NAME LIKE CONCAT('%', #{edu_name}, '%')
	    </if>
	    <if test="edu_name !=null and area_nm != ''">
	      	AND b.COPER_AREA_CD = #{area_nm}
	    </if>
	    <if test="orgSearch !=null and orgSearch == 'TEXT'">
	      	AND a.EDU_ORG_NAME LIKE CONCAT('%', #{edu_org_name}, '%')
	    </if>
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getInsActListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
		AND b.INS_TYPE = 'recruit'
        AND b.INS_STATUS IS NULL
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.EDU_START_DATE >= #{start_date} AND a.EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name !=null and edu_name != ''">
	      	AND a.EDU_NAME LIKE CONCAT('%', #{edu_name}, '%')
	    </if>
	    <if test="edu_name !=null and area_nm != ''">
	      	AND b.COPER_AREA_CD = #{area_nm}
	    </if>
	    <if test="orgSearch !=null and orgSearch == 'TEXT'">
	      	AND a.EDU_ORG_NAME LIKE CONCAT('%', #{edu_org_name}, '%')
	    </if>
	</select>
	
	<insert id="instructor03Save" parameterType="java.util.Map">	
		INSERT INTO EDU_SCHEDULE_APP
		(SCHEDULE_NO,EDU_KEY,INS_USER,REG_DT,REG_ID)
		VALUES(#{sch_no},#{edu_no},#{app_user},DATE_FORMAT(NOW(),'%x-%m-%d'),#{UserAccount.user_id})
	</insert>
	
	<select id="getInsLectureList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.SCHEDULE_NO, 
			   a.EDU_NAME,
			   a.EDU_START_DATE AS EDU_DATE,
               CONCAT(SUBSTR(TIME(b.START_TIME),1,2),':',SUBSTR(TIME(b.START_TIME),4,2),'~',SUBSTR(TIME(b.END_TIME),1,2),':',SUBSTR(TIME(b.END_TIME),4,2)) AS EDU_DATETIME,
               (SELECT CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '32' AND CD = b.COPER_AREA_CD) AS AREA_NM,
               a.EDU_ORG_NAME, b.EDU_PLACE, a.EDU_NUMBER,
               a.EDU_TARGET, a.EDU_TEAC_NAME,
               CASE WHEN b.INS_TYPE = 'recruit' AND INS_STATUS IS NULL THEN '섭외중'
					WHEN b.INS_TYPE = 'recruit' AND INS_STATUS IS NOT NULL THEN '완료'
					WHEN b.INS_TYPE = 'select' AND INS_STATUS IS NULL THEN '완료'
				END
               AS INS_STATUS,
               b.SCH_STATUS,
               a.EDU_KEY,
               (SELECT 'Y' FROM EDU_SCHEDULE_APP WHERE INS_USER = #{UserAccount.user_id}) AS INS_APP_CHECK
		FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
        AND a.EDU_TEAC_ID = #{UserAccount.user_id}
		<if test=" category1_key !=null and category1_key !=0">
			AND a.CATEGORY1_KEY = #{category1_key} 
		</if>
		<if test=" category2_key !=null and category2_key !=0 ">
			AND a.CATEGORY2_KEY = #{category2_key} 
		</if>
		<if test=" category3_key !=null and category3_key !=0">
			AND a.CATEGORY3_KEY = #{category3_key} 
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.EDU_START_DATE >= #{start_date} AND a.EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name !=null and edu_name != ''">
	      	AND a.EDU_NAME LIKE CONCAT('%', #{edu_name}, '%')
	    </if>
	    <if test="edu_name !=null and area_nm != ''">
	      	AND b.COPER_AREA_CD = #{area_nm}
	    </if>
	    <if test="orgSearch !=null and orgSearch == 'TEXT'">
	      	AND a.EDU_ORG_NAME LIKE CONCAT('%', #{edu_org_name}, '%')
	    </if>
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getInsLectureListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
        AND a.EDU_TEAC_ID = #{UserAccount.user_id}
		<if test=" category1_key !=null and category1_key !=0">
			AND a.CATEGORY1_KEY = #{category1_key} 
		</if>
		<if test=" category2_key !=null and category2_key !=0 ">
			AND a.CATEGORY2_KEY = #{category2_key} 
		</if>
		<if test=" category3_key !=null and category3_key !=0">
			AND a.CATEGORY3_KEY = #{category3_key} 
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.EDU_START_DATE >= #{start_date} AND a.EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name !=null and edu_name != ''">
	      	AND a.EDU_NAME LIKE CONCAT('%', #{edu_name}, '%')
	    </if>
	    <if test="edu_name !=null and area_nm != ''">
	      	AND b.COPER_AREA_CD = #{area_nm}
	    </if>
	    <if test="orgSearch !=null and orgSearch == 'TEXT'">
	      	AND a.EDU_ORG_NAME LIKE CONCAT('%', #{edu_org_name}, '%')
	    </if>
	</select>
	
	<select id="getInsLectureAllCnt" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT COUNT(a.SCHEDULE_NO) AS ALL_CNT,
			   COUNT(CASE WHEN DATE_FORMAT(a.EDU_START_DATE,'%x') = DATE_FORMAT(NOW(),'%x') THEN 1 END) AS CNT
		FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
        AND a.EDU_TEAC_ID = #{UserAccount.user_id}
        <if test=" category1_key !=null and category1_key !=0">
			AND a.CATEGORY1_KEY = #{category1_key} 
		</if>
		<if test=" category2_key !=null and category2_key !=0 ">
			AND a.CATEGORY2_KEY = #{category2_key} 
		</if>
		<if test=" category3_key !=null and category3_key !=0">
			AND a.CATEGORY3_KEY = #{category3_key} 
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.EDU_START_DATE >= #{start_date} AND a.EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name !=null and edu_name != ''">
	      	AND a.EDU_NAME LIKE CONCAT('%', #{edu_name}, '%')
	    </if>
	    <if test="edu_name !=null and area_nm != ''">
	      	AND b.COPER_AREA_CD = #{area_nm}
	    </if>
	    <if test="orgSearch !=null and orgSearch == 'TEXT'">
	      	AND a.EDU_ORG_NAME LIKE CONCAT('%', #{edu_org_name}, '%')
	    </if>
	</select>
	
	<insert id="instructor04Save" parameterType="java.util.Map">	
		INSERT INTO EDU_INSTRUCTOR_LEAVE 
		(INSTRUCTOR_IDX, REASON, S_DATE, E_DATE, REG_DT, REG_ID)
		SELECT  a.INSTRUCTOR_IDX, 
					#{reason} AS REASON,
		            DATE_FORMAT(#{s_date},'%x-%m-%d') AS S_DATE,
		            DATE_FORMAT(#{e_date},'%x-%m-%d') AS E_DATE,
		            DATE_FORMAT(NOW(),'%x-%m-%d') AS REG_DT,
		            #{UserAccount.user_id} AS REG_ID
			FROM EDU_INSTRUCTOR a WHERE a.COM_USER_ID = #{UserAccount.user_id}
	</insert>
	
	<select id="getInsEduAppList" parameterType="java.util.Map" resultType="java.util.Map">
		<![CDATA[
		SELECT (select CATEGORY3_NAME From EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = a.CATEGORY3_KEY) AS EDU_NAME,
				a.TRAIN_S_DATE, a.TRAIN_E_DATE,
                a.EDU_METHOD, a.EDU_NO,
                (CASE WHEN a.TRAIN_S_DATE <= NOW() AND a.TRAIN_E_DATE >= NOW() THEN '교육중' 
					  WHEN a.TRAIN_E_DATE < NOW() THEN '교육종료'
				 END) AS EDU_STATUS,
				 ]]>
				CASE b.COUR_STAT
			 		WHEN 1 THEN '완료'
			 		ELSE '미완료'
				 END AS COUR_STAT,     
                (CASE WHEN b.COUR_NO != '' THEN 'Y' END) AS APP_CHK
        FROM (SELECT *
				FROM EDU_REGISTRATION
		        WHERE 1=1
		        AND CATEGORY1_KEY = '3' 
				AND CATEGORY2_KEY = '7'
				<if test="start_date !=null and start_date !=''">
				    <![CDATA[
				     AND TRAIN_S_DATE >= #{start_date}
				    ]]>
				</if>
				<if test="end_date !=null and end_date !=''">
					<![CDATA[
				     AND TRAIN_E_DATE <= #{end_date}
				    ]]> 
				</if>	
				)a 
		LEFT JOIN EDU_COURSE_REGISTRATION b
		ON a.EDU_NO = b.EDU_NO
        AND b.USER_ID = #{UserAccount.user_id} 
		
		<if test="edu_nm != '' and edu_nm != null and eduSearch =='TEXT'">
			AND a.CATEGORY3_KEY IN (SELECT CATEGORY3_KEY FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%',#{edu_nm},'%'))
		</if>
		LIMIT #{recordCountPerPage} OFFSET #{offset}
		
	</select>
	
	<select id="getInsEduAppListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM (SELECT *
				FROM EDU_REGISTRATION
		        WHERE 1=1
		        AND CATEGORY1_KEY = '3' 
				AND CATEGORY2_KEY = '7'
				<if test="start_date !=null and start_date !=''">
				    <![CDATA[
				     AND TRAIN_S_DATE >= #{start_date}
				    ]]>
				</if>
				<if test="end_date !=null and end_date !=''">
					<![CDATA[
				     AND TRAIN_E_DATE <= #{end_date}
				    ]]> 
				</if>	
				)a 
		LEFT JOIN EDU_COURSE_REGISTRATION b
		ON a.EDU_NO = b.EDU_NO
        AND b.USER_ID = #{UserAccount.user_id} 
		<if test="edu_nm != '' and edu_nm != null and eduSearch =='TEXT'">
			AND a.CATEGORY3_KEY IN (SELECT CATEGORY3_KEY FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%',#{edu_nm},'%'))
		</if>
	</select>
	
	<insert id="instructor05Save" parameterType="java.util.Map">	
		INSERT INTO EDU_COURSE_REGISTRATION(
		  	  COUR_NO
		  	, EDU_NO
		  	, USER_ID
		  	, USER_NM
		  	, EML_ADDR
		  	, MBL_TELNO
		  	, REG_ID
		) VALUES (
			  (SELECT MAX(a.COUR_NO)+1 FROM EDU_COURSE_REGISTRATION a)
			, #{edu_no}
			, #{UserAccount.user_id}
			, #{UserAccount.user_nm}
			, #{UserAccount.eml_addr}
			, #{UserAccount.mbl_telno}
			, #{UserAccount.user_id}
		)	
	</insert>
	<!-- 관리자 -->
	
	<select id="getInstructorAllCnt" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT COUNT(b.USER_ID) AS ALL_CNT
			  ,COUNT(CASE b.INS_STATUS WHEN '1' THEN 1 END) AS CNT1
			  ,COUNT(CASE b.INS_STATUS WHEN '2' THEN 1 END) AS CNT2
			  ,COUNT(CASE b.INS_STATUS WHEN '3' THEN 1 END) AS CNT3
        FROM (
        SELECT  USER_ID
			   ,(SELECT STATUS FROM EDU_INSTRUCTOR WHERE COM_USER_ID = a.USER_ID) AS INS_STATUS
		FROM COM_USER a
		where 1=1
		AND a.EDU_AUTH_CD IN ('03','04')
		<if test=" category3_key !=null and category3_key !=0 and category_chk == 'ALL'">
			AND a.USER_ID IN (SELECT DISTINCT USER_ID FROM COM_USER_EDUINFO WHERE EDU_CD = #{category3_key})
		</if>
        ) b
	</select>
	
	<select id="getInstructorList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.* 
			   ,(SELECT CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '32' AND CD = a.AREA_CD) AS AREA_NM
			   ,CASE
					   WHEN a.USER_SEX = 'M' THEN '남자'
					   WHEN a.USER_SEX = 'W' THEN '여자'
					   ELSE a.USER_SEX
				      END AS USER_SEX_NM
			   ,(SELECT CASE WHEN STATUS = '1' THEN '활동' 
						 WHEN STATUS = '2' THEN '상실' 
	                     WHEN STATUS = '3' THEN '휴직' 
					END
				 FROM EDU_INSTRUCTOR WHERE COM_USER_ID = a.USER_ID) AS INS_STATUS
			   ,(SELECT CASE WHEN CLASS = '1' THEN '일반' 
							 WHEN CLASS = '2' THEN '실무자' 
		                     WHEN CLASS = '3' THEN '기관' 
		                     WHEN CLASS = '4' THEN '기업' 
						END
				 FROM EDU_INSTRUCTOR WHERE COM_USER_ID = a.USER_ID) AS INS_CLASS
			   ,(SELECT COUNT(*) FROM EDU_SCHEDULE WHERE EDU_TEAC_ID = a.USER_ID AND DATE_FORMAT(EDU_START_DATE,'%x') = DATE_FORMAT(NOW(),'%x')) AS EDU_COUNT
			   ,(SELECT COUNT(*) FROM EDU_SCHEDULE WHERE EDU_TEAC_ID = a.USER_ID) AS EDU_ALL_COUNT
			   ,(SELECT REG_DT FROM EDU_INSTRUCTOR WHERE COM_USER_ID = a.USER_ID) AS LICENSE_DT   
               ,CASE WHEN (SELECT INS_OFF_STATUS FROM EDU_INSTRUCTOR WHERE COM_USER_ID = a.USER_ID) = '1' THEN '완료' ELSE '미완료' END AS INS_OFF_STATUS
               ,CASE WHEN (SELECT COUNT(*) FROM EDU_COURSE_REGISTRATION WHERE USER_ID = a.USER_ID AND EDU_NO IN (SELECT EDU_NO FROM EDU_REGISTRATION WHERE CATEGORY1_KEY = '3' AND CATEGORY2_KEY = '7')) > 0 THEN '완료'
					ELSE '미완료' END AS ON_CHK
		FROM COM_USER a
		where 1=1
		AND a.EDU_AUTH_CD IN ('03','04')
		<if test=" category3_key !=null and category3_key !=0 and category_chk == 'ALL'">
			AND a.USER_ID IN (SELECT DISTINCT USER_ID FROM COM_USER_EDUINFO WHERE EDU_CD = #{category3_key})
		</if>
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>

	<select id="getInstructorListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM COM_USER a
		where 1=1
		AND a.EDU_AUTH_CD IN ('03','04')
		<if test=" category3_key !=null and category3_key !=0 and category_chk == 'ALL'">
			AND a.USER_ID IN (SELECT DISTINCT USER_ID FROM COM_USER_EDUINFO WHERE EDU_CD = #{category3_key})
		</if>
	</select>
	
	<select id="getCodeList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT CD, CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '${code}'
	</select>
	
	<select id="getInstructorView" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.*
		FROM COM_USER a
		WHERE a.USER_ID = #{user_id}
	</select>
	
	<update id="updateUserData" parameterType="java.util.Map">	
		UPDATE COM_USER
		SET	USER_NM = #{user_nm}, 	
		<if test="password != null and password != ''">
			PASSWORD = #{shaPassword}, 	
		</if>
			TELNO = #{telno},
			MBL_TELNO = #{mbl_telno},
			FAXNO = #{faxno},
			EML_ADDR = CONCAT(#{eml_addr1},'@',#{eml_addr2}),
			USER_SEX = #{user_sex},
			AREA_CD = #{area_cd},
			COPER_NM = #{coper_nm}
		WHERE USER_ID = #{user_id} 		
	</update>
	
	<insert id="updateInstructorData" parameterType="java.util.Map">	
		 INSERT INTO
      		EDU_INSTRUCTOR (
	         COM_USER_ID,
	         STATUS,
	         CLASS,
	         REG_DT,
	         REG_ID,
	         USE_YN
		      )
		   VALUES (
		      #{user_id},
		      #{status},
		      #{class},
		      DATE_FORMAT(NOW(),'%x-%m-%d'),
		      #{UserAccount.user_id},
		      'Y'
		   )
		   ON
		      DUPLICATE KEY
		   UPDATE
		      STATUS = #{status},
		      CLASS = #{class}    
	</insert>
	
	<select id="getMyEduInfo" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT b.COPER_NM,
				(SELECT CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '32' AND CD = b.AREA_CD) AS AREA_NM,
				b.MBL_TELNO,
				c.LICENSE_NUMBER,
				b.REG_DT,
				CASE WHEN a.STATUS = '1' THEN '활동강사'
					 WHEN a.STATUS = '2' THEN '상실강사'
					 WHEN a.STATUS = '3' THEN '휴직강사'
				END AS STATUS
		FROM EDU_INSTRUCTOR a,
			 COM_USER b,
		     EDU_USER_LICENSE c
		WHERE a.COM_USER_ID = b.USER_ID
		AND a.COM_USER_ID = c.USER_ID
		AND c.CATEGORY1_KEY = '1'
		AND c.CATEGORY2_KEY = '2'
		AND a.COM_USER_ID = #{UserAccount.user_id}
	</select>
	
	<select id="getMyEduAuthList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  a.CATEGORY3_NAME,
				b.EDU_CD,
		        b.AUTH_SDATE,
		        b.AUTH_EDATE
		FROM (SELECT * 
			FROM EDU_CLASS_CATEGORY3
		    WHERE CATEGORY1_KEY = '7' 
			AND CD_NO IS NOT NULL) a
		    LEFT JOIN COM_USER_EDUINFO b
		ON a.CD_NO = b.EDU_CD
		AND a.CATEGORY1_KEY = '7' 
		AND a.CD_NO IS NOT NULL 
		AND b.USER_ID = #{UserAccount.user_id}
		ORDER BY CAST(a.CD_NO AS unsigned)
	</select>
	
	<select id="getlectureCount" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT SUM(CNT),SUM(CNT2), SUM(ALLCNT) FROM ( 
        select (CASE WHEN DATE_FORMAT(EDU_START_DATE,'%d') = DATE_FORMAT('2022-04-20','%d') THEN 1  ELSE 0 END) AS CNT,
				(CASE WHEN DATE_FORMAT(EDU_START_DATE,'%x') = DATE_FORMAT(NOW(),'%x') THEN 1  ELSE 0 END) AS CNT2,
                1 AS ALLCNT
		from EDU_SCHEDULE 
        WHERE 1=1)
        AND EDU_TEAC_ID = 'lms-test01'
        <!-- 카운트확인 -->
    </select>
</mapper>
