<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.easycompany.mapper.MyMapper">
	<select id="getCartList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.BASKET_NO,b.EDU_TIME,b.INST_NM,b.EDU_NO,a.user_id
			   ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		FROM EDU_BASKET a, 
			 EDU_REGISTRATION b
		WHERE 1=1
		AND a.EDU_NO = b.EDU_NO
		AND b.CATEGORY1_KEY = #{category1_key}
		AND a.USER_ID = #{UserAccount.user_id}
		ORDER BY BASKET_NO DESC
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>

	<select id="getCartListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_BASKET a, 
			 EDU_REGISTRATION b
		WHERE 1=1
		AND a.EDU_NO = b.EDU_NO
		AND b.CATEGORY1_KEY = #{category1_key}
		AND a.USER_ID = #{UserAccount.user_id}
	</select>
	
	<delete id="deleteCart" parameterType="java.util.Map">	
		DELETE FROM EDU_BASKET
		WHERE BASKET_NO IN (
			<foreach collection="basketList" item="item" separator=",">
				#{item}
			</foreach>
		) 
	</delete>
	
	<delete id="deleteCour" parameterType="java.util.Map">	
		DELETE FROM EDU_COURSE_REGISTRATION
		WHERE COUR_NO IN (
			<foreach collection="basketList" item="item" separator=",">
				#{item}
			</foreach>
		) 
	</delete>
	
	<select id="getStatusList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME
				,(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME
		        ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		        ,DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.INST_NM
                ,CASE WHEN b.TRAIN_S_DATE > NOW() THEN 'Y' ELSE 'N' END AS CANCEL_CHECK 
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND (USE_YN = 'Y' OR USE_YN IS NULL)
		AND a.USER_ID = #{UserAccount.user_id}
		<if test="category1_key != '' and category1_key != null">
			AND b.CATEGORY1_KEY = #{category1_key}
		</if>
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  REG_DT >= #{start_date} AND REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		ORDER BY COUR_NO DESC
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getStatusListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND (USE_YN = 'Y' OR USE_YN IS NULL)
		AND a.USER_ID = #{UserAccount.user_id}
		<if test="category1_key != '' and category1_key != null">
			AND b.CATEGORY1_KEY = #{category1_key}
		</if>
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  REG_DT >= #{start_date} AND REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
	</select>
	
	<select id="getEduAllCnt" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  COUNT(c.COUR_NO) AS ALL_CNT,
				COUNT(CASE WHEN COUR_STAT=1 THEN 1 END) AS END_CNT,
		        COUNT(CASE WHEN COUR_STAT!=1 THEN 1 END) AS ING_CNT
		FROM (
			SELECT  a.COUR_NO
			,a.COUR_STAT
			FROM EDU_COURSE_REGISTRATION a, 
				 EDU_REGISTRATION b
			WHERE a.EDU_NO = b.EDU_NO
			AND a.USER_ID = #{UserAccount.user_id}
			<![CDATA[
			AND TRAIN_S_DATE <= NOW() 
	        ]]>
			<if test="category1_key != '' and category1_key != null">
				AND b.CATEGORY1_KEY = #{category1_key}
			</if>
			<if test="category2_key != '' and category2_key != null">
				AND b.CATEGORY2_KEY = #{category2_key}
			</if>
			<if test="category3_key != '' and category3_key != null">
				AND b.CATEGORY3_KEY = #{category3_key}
			</if>
			<choose>
				<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
				</when>
				<when
					test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
					AND REG_DT = NOW()
				</when>
				<when
					test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
			      <![CDATA[
			       AND  REG_DT >= #{start_date} AND REG_DT <= #{end_date} 
			       ]]>
				</when>
			</choose>
			) c
	</select>
	
	<select id="getEduList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME
				,(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME
		        ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		        ,DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.INST_NM
		        ,a.USER_NM, a.COUR_NO
		        ,CASE a.COUR_STAT
			 		WHEN 1 THEN '완료'
			 		ELSE '미완료'
				 END AS COUR_STAT 
				,CASE a.COUR_STAT
			 		WHEN 1 THEN '교육완료'
			 		ELSE '교육전'
				 END AS OFF_STAT   <!-- //교육기간 확인후 수정 -->   
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		AND b.EDU_SITE = #{site}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		<if test="edu_status != '' and edu_status != null">
			AND COUR_STAT = #{edu_status}
		</if>
		<if test="category1_key != '' and category1_key != null">
			AND b.CATEGORY1_KEY = #{category1_key}
		</if>
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		ORDER BY COUR_NO DESC
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getEduListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		 FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		AND b.EDU_SITE = #{site}
		<![CDATA[
        AND TRAIN_S_DATE <= NOW() 
        ]]>
		<if test="edu_status != ''">
			AND a.COUR_STAT = 1
		</if>
		<if test="category1_key != '' and category1_key != null">
			AND b.CATEGORY1_KEY = #{category1_key}
		</if>
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
	</select>
	
	<select id="getEduIngList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME
				,(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME
		        ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		        ,DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.INST_NM, b.EDU_TIME
                ,(SELECT TIME_FORMAT(SEC_TO_TIME(SUM(c.COUR_TIME)), '%H시간 %i분 %s초') FROM EDU_COURSE_ONLINE c WHERE c.COUR_NO = a.COUR_NO AND c.USER_ID = a.USER_ID) AS COUR_TIME
		        ,a.USER_NM, a.COUR_NO, b.EDU_NO
		        ,CASE a.COUR_STAT
			 		WHEN 1 THEN '완료'
			 		ELSE '미완료'
				 END AS COUR_STAT         
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		AND (a.COUR_STAT != '1' OR a.COUR_STAT IS NULL)
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name != '' and edu_name != null">
			AND b.CATEGORY3_NAME = #{edu_name}
		</if>
		ORDER BY COUR_NO DESC
	</select>
	
	<select id="getEduEndList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME
				,(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME
		        ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		        ,DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.INST_NM, b.EDU_TIME
                ,(SELECT TIME_FORMAT(SEC_TO_TIME(SUM(c.COUR_TIME)), '%H시간 %i분 %s초') FROM EDU_COURSE_ONLINE c WHERE c.COUR_NO = a.COUR_NO AND c.USER_ID = a.USER_ID) AS COUR_TIME
		        ,a.USER_NM, a.COUR_NO, b.EDU_NO
		        ,CASE a.COUR_STAT
			 		WHEN 1 THEN '완료'
			 		ELSE '미완료'
				 END AS COUR_STAT         
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		AND COUR_STAT = '1'
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  REG_DT >= #{start_date} AND REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_name != '' and edu_name != null">
			AND b.CATEGORY3_NAME = #{edu_name}
		</if>
		ORDER BY COUR_NO DESC
	</select>
	
	<select id="getCourInfo" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME,
				(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME,
		        (SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME,
		        b.INST_NM, DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.EDU_TIME,
                (SELECT COUNT(*) FROM EDU_COURSE_ONLINE WHERE COUR_NO = a.COUR_NO AND USER_ID = a.USER_ID AND COUR_STAT = '1') AS SECTOR_CNT1,
                (SELECT COUNT(*) FROM EDU_REGISTRATION_DETAIL WHERE EDU_NO = b.EDU_NO) AS SECTOR_CNT2,
                (SELECT IFNULL(TIME_FORMAT(SEC_TO_TIME(SUM(COUR_TIME)), '%H시간 %i분 %s초'),0) FROM EDU_COURSE_ONLINE WHERE EDU_NO = a.EDU_NO AND COUR_NO = a.COUR_NO) AS COUR_TIME,
                CASE WHEN a.COUR_STAT = '1' THEN '학습완료'
					 ELSE '학습중' END AS COUR_STAT
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND b.EDU_NO = #{edu_no}
		AND a.COUR_NO = #{cour_no}
        AND a.USER_ID = #{UserAccount.user_id}
	</select>
	
	<select id="getCourSecList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  b.EDU_SUB_NO, 
				b.EDU_CURR1, 
                b.EDU_CURR2,
                b.EDU_CURR3,
                b.FILE_ID,
                b.EDU_ON_APP_TIME,
                (SELECT IFNULL(TIME_FORMAT(SEC_TO_TIME(SUM(COUR_TIME)), '%H시간 %i분 %s초'),0) FROM EDU_COURSE_ONLINE WHERE EDU_NO = b.EDU_NO AND COUR_NO = #{cour_no} AND USER_ID = #{UserAccount.user_id}) AS COUR_TIME,
                b.EDU_CON_URL,
                (SELECT (CASE WHEN COUR_STAT = '1' THEN '완료' ELSE '미완료' END) FROM EDU_COURSE_ONLINE WHERE EDU_SUB_NO = b.EDU_SUB_NO) AS COUR_STAT
        FROM EDU_REGISTRATION_DETAIL b
		WHERE b.EDU_NO = #{edu_no}
	</select>
	
	<select id="getOnclassTime" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT  (SELECT COUR_TIME FROM EDU_COURSE_ONLINE WHERE USER_ID = #{UserAccount.user_id} AND EDU_SUB_NO = a.EDU_SUB_NO) AS COUR_TIME,
		(SELECT COUR_STAT FROM EDU_COURSE_ONLINE WHERE USER_ID = #{UserAccount.user_id} AND EDU_SUB_NO = a.EDU_SUB_NO) AS COUR_STAT,
        a.EDU_CON_URL, a.EDU_NO
		FROM EDU_REGISTRATION_DETAIL a
		WHERE 1=1
		AND a.EDU_SUB_NO = #{edu_sub_no}
	</select>

	<update id="onclassUpdate" parameterType="java.util.Map">	
		INSERT INTO EDU_COURSE_ONLINE (
			COUR_NO, EDU_NO, EDU_SUB_NO, USER_ID, COUR_TIME, COUR_STAT, REG_DT, REG_ID
		)VALUES(
			#{cour_no},#{edu_no},#{edu_sub_no},#{UserAccount.user_id},#{cour_time},#{cour_stat},DATE_FORMAT(NOW(),'%x-%m-%d'),#{UserAccount.user_id}
		)
		ON
	      DUPLICATE KEY
	   UPDATE
	      COUR_TIME = #{cour_time},
	      COUR_STAT = #{cour_stat}
	</update>
	
	<select id="onclassFinishCheck" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT (SELECT COUNT(*) from EDU_REGISTRATION_DETAIL WHERE EDU_NO = a.EDU_NO) AS ALLCNT,
				SUM(CASE WHEN COUR_STAT = '1' THEN 1 ELSE 0 END) AS CNT
        FROM EDU_COURSE_ONLINE a WHERE a.USER_ID = #{UserAccount.user_id}
	</select>
	
	<update id="onclassFinish" parameterType="java.util.Map">	
		UPDATE EDU_COURSE_REGISTRATION
		SET COUR_STAT = '1', CHG_DT = NOW()
		WHERE COUR_NO = #{cour_no}
		  AND EDU_NO = #{edu_no}
	</update>
	
	<update id="myWarrantUpdate" parameterType="java.util.Map">	
		UPDATE EDU_COURSE_REGISTRATION
		SET LICENSE_PBL = '1', LICENSE_PBL_DATE = NOW()
		WHERE COUR_NO = #{cour_no}
		  AND EDU_NO = #{edu_no}
	</update><!--수정해야함-->
	
	<select id="getWarrantList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME
				,(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME
		        ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		        ,DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.INST_NM
		        ,a.USER_NM, a.COUR_NO, a.EDU_NO
		        ,DATE_FORMAT(a.LICENSE_PBL_DATE,'%Y-%m-%d') AS LICENSE_PBL_DATE
		        ,CASE a.LICENSE_PBL
			 		WHEN 1 THEN '발급'
			 		ELSE '미발급'
				 END AS LICENSE_PBL      
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		AND COUR_STAT = 1
		AND b.CATEGORY1_KEY = #{category1_key}
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<choose>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='ALL' ">
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='1' ">
				AND LICENSE_PBL = '1'
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='2' ">
		      	AND LICENSE_PBL = '2'
			</when>
		</choose>
		ORDER BY COUR_NO DESC
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getWarrantListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		AND COUR_STAT = 1
		AND b.CATEGORY1_KEY = #{category1_key}
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<choose>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='ALL' ">
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='1' ">
				AND LICENSE_PBL = '1'
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='2' ">
		      	AND LICENSE_PBL = '2'
			</when>
		</choose>
	</select>
	
	<select id="getMyWarrant" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT  a.USER_NM, a.USER_ID
			,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
            ,DATE_FORMAT(IFNULL(a.CHG_DT,NOW()),'%Y년 %m월 %d일') AS DATE1
            ,DATE_FORMAT(NOW(), '%y') AS NOWYEAR
            ,(SELECT LICENSE_NUMBER FROM EDU_USER_LICENSE WHERE COUR_NO = a.COUR_NO AND EDU_NO = a.EDU_NO) AS LICENSE_NUMBER
            ,(SELECT COPER_NM FROM COM_USER WHERE USER_ID = a.USER_ID) AS COPER_NM
            ,(SELECT DATE_FORMAT(REG_DT,'%Y년 %m월 %d일') FROM EDU_USER_LICENSE WHERE COUR_NO = a.COUR_NO AND EDU_NO = a.EDU_NO) AS DATE2
			,a.LICENSE_PBL
			,a.LICENSE_PBL_DATE
            ,CASE WHEN b.CATEGORY2_KEY = '2' OR b.CATEGORY2_KEY = '8' THEN '번호'
				  WHEN b.CATEGORY2_KEY = '4' OR b.CATEGORY2_KEY = '10' THEN '번호'
                  WHEN b.CATEGORY2_KEY = '5' OR b.CATEGORY2_KEY = '11' THEN '번호'
                  WHEN b.CATEGORY2_KEY = '6' OR b.CATEGORY2_KEY = '12' THEN '번호'
                  ELSE '일반' END AS LICENSE_GUBUN
			,(SELECT LICENSE_IDX FROM EDU_USER_LICENSE WHERE COUR_NO = a.COUR_NO) AS LICENSE_CHK   
		FROM EDU_COURSE_REGISTRATION a,
			 EDU_REGISTRATION b
		 WHERE 1=1
		  AND a.EDU_NO = b.EDU_NO
		  AND a.COUR_NO = #{cour_no}
		  AND a.EDU_NO = #{edu_no}
	</select>
	
	<select id="getMyList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT BOARD_IDX,
	    TITLE, LINK_URL, FILE_ID, VIEW_CNT, CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19) ) AS REG_DT, REG_ID, REG_NM,
	    (SELECT COUNT(*) FROM edu_file WHERE FILE_KEY = BOARD_IDX AND FILE_GUBUN = 'board') AS FIEL_CNT, CONTENTS
	      FROM edu_board
		WHERE REG_ID = #{UserAccount.user_id}
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) = NOW()
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) >= #{start_date} 
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) <= #{end_date} 
		       ]]>
			</when>
		</choose>
	     ORDER BY BOARD_IDX DESC
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getMyListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		  FROM edu_board
		WHERE REG_ID = #{UserAccount.user_id}
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) = NOW()
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) >= #{start_date} 
		       AND CAST( DATE_FORMAT( REG_DT, '%Y-%m-%d' ) AS CHAR(19)) <= #{end_date} 
		       ]]>
			</when>
		</choose>
	</select>
	
	<select id="getInsActList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.SCHEDULE_NO, a.EDU_START_DATE AS EDU_DATE,
	       CONCAT(SUBSTR(TIME(b.START_TIME),1,2),':',SUBSTR(TIME(b.START_TIME),4,2),'~',SUBSTR(TIME(b.END_TIME),1,2),':',SUBSTR(TIME(b.END_TIME),4,2)) AS EDU_DATETIME,
	       (SELECT CD_NM FROM COM_CD_MNG WHERE UP_CD_NO = '32' AND CD = b.COPER_AREA_CD) AS AREA_NM,
	       b.EDU_PLACE, a.EDU_ORG_NAME, a.EDU_NAME, a.EDU_TARGET, a.EDU_NUMBER, c.REG_DT, 
	       CASE WHEN b.INS_STATUS IS NULL THEN '취소하기'
				ELSE '변경불가' END AS INS_STATUS, 
	       CASE WHEN c.INS_CONFIRM = 'Y' THEN '선택'
				ELSE '미선택' END AS INS_CONFIRM, a.EDU_KEY
		FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b,
		     EDU_SCHEDULE_APP c
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
		AND a.SCHEDULE_NO = c.SCHEDULE_NO
		AND c.INS_USER = #{UserAccount.user_id}
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  EDU_START_DATE >= #{start_date} AND EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_nm != '' and edu_nm != null">
			AND a.EDU_NAME LIKE CONCAT('%',#{edu_nm},'%') 
		</if>
		<if test="area_nm != '' and area_nm != null">
			AND b.COPER_AREA_CD = #{area_nm}
		</if>
		<if test="edu_org_name != '' and edu_org_name != null">
			AND a.EDU_ORG_NAME LIKE CONCAT('%',#{edu_org_name},'%') 
		</if>
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getInsActListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM EDU_SCHEDULE a,
			 EDU_SCHEDULE_DETAIL b,
		     EDU_SCHEDULE_APP c
		WHERE a.SCHEDULE_NO = b.SCHEDULE_NO
		AND a.SCHEDULE_NO = c.SCHEDULE_NO
		AND c.INS_USER = #{UserAccount.user_id}
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND EDU_START_DATE = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  EDU_START_DATE >= #{start_date} AND EDU_START_DATE <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<if test="edu_nm != '' and edu_nm != null">
			AND a.EDU_NAME LIKE CONCAT('%',#{edu_nm},'%') 
		</if>
		<if test="area_nm != '' and area_nm != null">
			AND b.COPER_AREA_CD = #{area_nm}
		</if>
		<if test="edu_org_name != '' and edu_org_name != null">
			AND a.EDU_ORG_NAME LIKE CONCAT('%',#{edu_org_name},'%') 
		</if>
	</select>
	
	<select id="getAreaList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT CD, CD_NM 
		FROM COM_CD_MNG 
		WHERE UP_CD_NO = '32'
	</select>

	<select id="getInsLeaveList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT INSTRUCTOR_LEAVE_IDX, 
			   CASE WHEN STATUS = '1' THEN '승인'
			   		ELSE '미승인' END AS STATUS, 
			   CASE WHEN REASON = '1' THEN '출산 및 육아'
					WHEN REASON = '2' THEN '병가'
                    WHEN REASON = '3' THEN '해외연수'
                    ELSE '기타' END AS REASON, 
			   S_DATE, 
			   E_DATE,
			   REG_DT  
		FROM EDU_INSTRUCTOR_LEAVE
		WHERE INSTRUCTOR_IDX = (SELECT INSTRUCTOR_IDX FROM EDU_INSTRUCTOR WHERE COM_USER_ID = #{UserAccount.user_id})
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  REG_DT >= #{start_date} AND REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getInsLeaveListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM EDU_INSTRUCTOR_LEAVE
		WHERE INSTRUCTOR_IDX = (SELECT INSTRUCTOR_IDX FROM EDU_INSTRUCTOR WHERE COM_USER_ID = #{UserAccount.user_id})
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  REG_DT >= #{start_date} AND REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
	</select>
	
	<delete id="deleteInsLeave" parameterType="java.util.Map">	
		DELETE FROM EDU_INSTRUCTOR_LEAVE
		WHERE INSTRUCTOR_LEAVE_IDX = #{ins_idx}
	</delete>
	
	<select id="getInsEduList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT (select CATEGORY3_NAME From EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = a.CATEGORY3_KEY) AS EDU_NAME,
				a.TRAIN_S_DATE, a.TRAIN_E_DATE,
                a.EDU_METHOD, a.EDU_NO, DATE_FORMAT(b.REG_DT,'%Y-%m-%d') AS REG_DT, b.COUR_NO
        FROM (SELECT *
				FROM EDU_REGISTRATION
		        WHERE 1=1
		        AND CATEGORY1_KEY = '3' 
				AND CATEGORY2_KEY = '7'
				<if test="edu_nm != '' and edu_nm != null and eduSearch =='TEXT'">
					AND CATEGORY3_KEY IN (SELECT CATEGORY3_KEY from EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%',#{edu_nm},'%')) 
				</if>
				<choose>
					<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
					</when>
					<when test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
					<![CDATA[
						AND TRAIN_S_DATE <= NOW() AND TRAIN_E_DATE >= NOW()
					]]>
					</when>
					<when test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
				      <![CDATA[
				       AND  TRAIN_S_DATE >= #{start_date} AND TRAIN_E_DATE <= #{end_date} 
				       ]]>
					</when>
				</choose>
				)a,
			 EDU_COURSE_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
        AND b.USER_ID = #{UserAccount.user_id}
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getInsEduListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM (SELECT *
				FROM EDU_REGISTRATION
		        WHERE 1=1
		        AND CATEGORY1_KEY = '3' 
				AND CATEGORY2_KEY = '7'
				<if test="edu_nm != '' and edu_nm != null and eduSearch =='TEXT'">
					AND CATEGORY3_KEY IN (SELECT CATEGORY3_KEY from EDU_CLASS_CATEGORY3 WHERE CATEGORY3_NAME LIKE CONCAT('%',#{edu_nm},'%')) 
				</if>
				<choose>
					<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
					</when>
					<when test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
					<![CDATA[
						AND TRAIN_S_DATE <= NOW() AND TRAIN_E_DATE >= NOW()
					]]>
					</when>
					<when test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
				      <![CDATA[
				       AND  TRAIN_S_DATE >= #{start_date} AND TRAIN_E_DATE <= #{end_date} 
				       ]]>
					</when>
				</choose>
				)a,
			 EDU_COURSE_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
        AND b.USER_ID = #{UserAccount.user_id}
	</select>
	
	<delete id="deleteInsEdu" parameterType="java.util.Map">	
		DELETE FROM EDU_COURSE_REGISTRATION
		WHERE COUR_NO = #{cour_no}
	</delete>
	
	<select id="getInsWarrantList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT  (SELECT CATEGORY1_NAME FROM EDU_CLASS_CATEGORY1 WHERE CATEGORY1_KEY = b.CATEGORY1_KEY) AS CATEGORY1_NAME
				,(SELECT CATEGORY2_NAME FROM EDU_CLASS_CATEGORY2 WHERE CATEGORY2_KEY = b.CATEGORY2_KEY) AS CATEGORY2_NAME
		        ,(SELECT CATEGORY3_NAME FROM EDU_CLASS_CATEGORY3 WHERE CATEGORY3_KEY = b.CATEGORY3_KEY) AS CATEGORY3_NAME
		        ,DATE_FORMAT(a.REG_DT,'%Y-%m-%d') AS REG_DT, b.INST_NM
		        ,a.USER_NM, a.COUR_NO, a.EDU_NO
		        ,DATE_FORMAT(a.LICENSE_PBL_DATE,'%Y-%m-%d') AS LICENSE_PBL_DATE
		        ,CASE a.LICENSE_PBL
			 		WHEN 1 THEN '발급'
			 		ELSE '미발급'
				 END AS LICENSE_PBL         
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		AND COUR_STAT = 1
		AND b.CATEGORY1_KEY = '3'
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<choose>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='ALL' ">
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='1' ">
				AND LICENSE_PBL = '1'
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='2' ">
		      	AND LICENSE_PBL = '2'
			</when>
		</choose>
		ORDER BY COUR_NO DESC
		LIMIT #{recordCountPerPage} OFFSET #{offset}
	</select>
	
	<select id="getInsWarrantListCnt" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM EDU_COURSE_REGISTRATION a, 
			 EDU_REGISTRATION b
		WHERE a.EDU_NO = b.EDU_NO
		AND a.USER_ID = #{UserAccount.user_id}
		<![CDATA[
		AND TRAIN_S_DATE <= NOW() 
        ]]>
		AND COUR_STAT = 1
		AND b.CATEGORY1_KEY = '3'
		<if test="category2_key != '' and category2_key != null">
			AND b.CATEGORY2_KEY = #{category2_key}
		</if>
		<if test="category3_key != '' and category3_key != null">
			AND b.CATEGORY3_KEY = #{category3_key}
		</if>
		<choose>
			<when test="searchDate !=null and searchDate !='' and searchDate =='ALL' ">
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='TODAY' ">
				AND a.REG_DT = NOW()
			</when>
			<when
				test="searchDate !=null and searchDate !='' and searchDate =='CHECK' ">
		      <![CDATA[
		       AND  a.REG_DT >= #{start_date} AND a.REG_DT <= #{end_date} 
		       ]]>
			</when>
		</choose>
		<choose>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='ALL' ">
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='1' ">
				AND LICENSE_PBL = '1'
			</when>
			<when test="license_pbl !=null and license_pbl !='' and license_pbl =='2' ">
		      	AND LICENSE_PBL = '2'
			</when>
		</choose>
	</select>
</mapper>
